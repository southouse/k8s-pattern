# 정상상태 점검 패턴
> 클라우드 네이티브 애플리케이션은 애플리케이션 상태를 유추 가능하도록 잘 관측될 수 있어야 함

## 문제
- 쿠버네티스는 컨테이너 프로세스 상태를 주기적으로 확인하고 문제가 감지되면 컨테이너를 다시 시작
- 어떤 이유(`OOM`, 무한 루프 또는 교착 상태 등)으로 프로세스는 실행 중인 경우가 있을 수 있기 때문에 프로세스로만 상태 확인하는건 충분하지 않음

> 애플리케이션의 정상상태(health)를 체크할 수 있는 신뢰할 만한 방법을 필요로 함

## 해결책
### 프로세스 정상상태 확인
- `kubelet`이 컨테이너 프로세스에 대해 지속적으로 수행하는 가장 간단한 정상상태 확인
- 대부분의 경우 프로세스 정상상태 확인만으로는 충분치 않아 다른 유형의 확인이 필요

### 라이브니스(생존상태) 점검
- 큐블릿 에이전트가 정기적으로 검사를 수행해 컨테이너가 여전히 정상상태인지 확인하는 과정
- 애플리케이션 자체 내부보다는 외부에서 정상상태 확인을 수행하는 것이 중요
- 종류
  - HTTP 점검: 컨테이너 IP 주소에 대해 HTTP GET 요청을 수행해 200-399 사이의 성공적인 HTTP 응답 코드를 기대
  - TCP 소켓 점검: 성공적인 TCP 연결을 가정
  - Exec 점검: 컨테이너 커널 네임스페이스에서 임의의 명령을 실행하고 성공적인 종료 코드를 기대
- 비정상적인 상태의 컨테이너를 종료하고 새로운 컨테이너로 대체
  
### 레디니스(준비상태) 점검
- 때로는 컨테이너가 정상상태가 아닐 수 있어, 재시작하는 것도 도움이 안될 때가 있음
  - 컨테이너가 여전히 시작중이고 요청을 처리할 준비가 안 됐을 경우
  - 컨테이너에 과부하가 걸려 지연 시간이 증가한 경우
  - ...
- 라이브니스 점검과는 다르게, 레디니스는 점검에 실패하면 컨테이너는 서비스 엔드포인트에서 제거되고 새로운 트래픽을 수신할 수 없음
- 서비스 요청을 받기 전에 준비할 수 있는 시간을 갖도록 컨테이너가 준비되는 시점에 신호를 보냄
- 라이브니스 점검과 똑같이 주기적으로 수행되므로, 이후 단계에서 트래픽으로부터 서비스를 보호하는 데 유용

### 정리
- 프로세스 정상상태 확인과 라이브니스 점검은 컨테이너를 재시작해 장애를 복구하기 위한 것
- 레디니스 점검은 애플리케이션에 준비할 시간을 주고 애플리케이션이 스스로 복구되길 기다림
- 애플리케이션의 정상상태에 대해 더 많은 가시성을 제공할 수 있는 방법은 로깅
- 컨테이너화된 애플리케이션은 최소한 정상상태 확인을 위한 API를 제공해야 함
- 트레이싱 및 메트릭 수집 라이브러리(OpenTracing, Prometheus)와 통합하여 컨테이너화된 애플리케이션 상태를 관찰할 수 있도록 또 다른 수단을 제공해야 함

> 완전 자동화를 위해, 클라우드 네이티브 애플리케이션은 관리 플랫폼에게 애플리케이션 정상상태를 읽고, 해석하고, 필요한 경우 조치 활동에 대한 수단을 제공함으로써 관찰 가능해야 함