# 배치 잡
> 배치 잡(Batch Job) 패턴은 독립된 원자 작업단위를 관리하는 데 적합

## 문제
- 쿠버네티스의 기본 요소 파드의 생성 방법
  - 순수 파드
  - 레플리카셋
    - 파드의 수명주기를 생성하고 관리하는 데 사용
    - 실행 중인 파드의 레플리카셋을 지속적으로 유지하고, 동일한 파드의 수가 가용함을 보장
  - 데몬셋
    - 모든 노드에 하나의 파드를 실행하는 컨트롤러
    - 모니터링, 로그 수집, 스토리지 등의 플랫폼 기능으로 사용
- 이런 파드는 시간이 지나도 멈추지 않는 장기 실행 프로세스

> 경우에 따라 미리 정의된 일정 시간의 작업단위를 안정적으로 실행한 후 컨테이너를 종료하는 것이 필요

## 해결책
### 잡(Job)
- 잡은 하나 이상의 파드를 생성하고 성공적으로 실행되는 것을 보장
- 완료된 잡은 더 이상 추가로 파드를 시작하지 않음
- `spec.template.spec.restartPolicy` 값이 필수이며, `OnFailure`이나 `Never` 값 중에 하나만 사용 가능
- 순수 파드 대신에 잡을 사용하는 이유
  - 일시적인 인메모리(in-memory) 작업이 아니라, 클러스터 재시작에도 살아남는 지속된 작업
  - 잡이 완료되면, 삭제되지 않고 추적 목적으로 유지 때문에 파드도 남아있어 로그 확인 등의 검사가 가능
  - `spec.completions` 값으로 잡이 완료되기 전에 파드가 성공적으로 끝나야 하는 횟수를 지정할 수 있음
  - `spec.parallelism` 값으로 여러 개의 파드르 동시에 실행하여 병렬로 처리가 가능
  - 노드에 장애가 생긴 경우에 파드를 새로운 정상상태 노드에 배치하여 잡을 수행
- 잡의 종류
  - 단일 파드 잡(Single Pod Job)
  - 고정 완료 횟수 잡(Fixed completion count Job)
    - `spec.completions`에 1보다 큰 수를 지정하여 잡을 생성
    - 설정 값과 같은 수의 파드가 성공적으로 완료되어야 잡이 완료
  - 작업 큐 잡(Work queue Job)
    - `spec.completions` 값을 생략하고, `spec.parallelism` 값을 1보다 큰 정수로 설정
    - 여러 개의 파드를 병렬로 생성하고 하나씩 완료 처리

## 정리
- 잡은 독립된 작업단위를 믿을 만하고 스케일 가능한 실행 단위로 전환할 수 있게 도와줌
- 작업 항목당 하나의 잡(One Job per work item)
  - 각 작업 항목이 독립적으로 기록, 추적, 확장되어야 하는 복잡한 작업일 경우 유용
- 모든 작업 항목에 대해 하나의 잡(One Job for all work items)
  - 개별적으로 추적될 필요가 없고 관리될 필요가 없는 많은 작업 항목에 적합
- 작업 항목 스케줄에 대한 최소 기본 사항만을 제공하기 때문에 복잡한 구현은 결과를 얻기 위한 배치(Batch) 애플리케이션 프레임워크(Spring Batch, Jberet 등)와 결합해야 함

> 짧은 수명 주기 작업에는 레플리카셋보다 잡을 사용하면, 플랫폼의 다른 워크로드에 쓸 자원이 절약됨